"use client";
import {useEffect, useState} from "react";
import {GoogleMap, Polyline, useLoadScript} from "@react-google-maps/api";
import {getDirections} from "@/acitons/getDirections/getDirections";

export default function Home() {
    const [route, setRoute] = useState<any>(null);
    const [error, setError] = useState<string | null>(null);
    const [startPosition, setStartPosition] = useState<string | null>(null);
    const [goalPosition, setGoalPosition] = useState<string | null>(null);

    const {isLoaded} = useLoadScript({
        googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || "",
    });

    const fetchRoute = async () => {
        const origin = goalPosition
        const destination = startPosition

        const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;

        try {
            const data = await getDirections(origin, destination, apiKey);
            if (data && data.routes.length > 0) {
                setRoute(data.routes[0]);
            } else {
                setError("No routes found.");
            }
        } catch (err) {
            console.error(err);
            setError("Failed to fetch route information.");
        }
    };

    if (!isLoaded) return <p>Loading Maps...</p>;

    return (
        <div>
            <h1>Route Information</h1>
            {error && <p style={{color: "red"}}>{error}</p>}
            {route ? (
                <div>
                    <h2>Route Overview</h2>
                    <p>
                        <strong>Distance:</strong> {route.legs[0].distance.text}
                    </p>
                    <p>
                        <strong>Duration:</strong> {route.legs[0].duration.text}
                    </p>
                    <GoogleMap
                        mapContainerStyle={{width: "100%", height: "400px"}}
                        center={{
                            lat: route.legs[0].start_location.lat,
                            lng: route.legs[0].start_location.lng,
                        }}
                        zoom={10}
                    >
                        <Polyline
                            path={decodePolyline(route.overview_polyline.points)}
                            options={{
                                strokeColor: "#FF0000",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                            }}
                        />
                    </GoogleMap>
                </div>
            ) : (
                <p>Loading route information...</p>
            )}
            <label htmlFor="start">
                スタート位置
                <input type="text" name={"start"} onChange={(e) => setStartPosition(e.target.value)}/>
            </label>
            <label htmlFor="goal">
                ゴール位置
                <input type="text" name={"goal"} onChange={(e) => setGoalPosition(e.target.value)}/>
            </label>

            <button onClick={fetchRoute}>
                送信
            </button>

            <svg
                width="400"
                height="400"

                viewBox="0 0 400 400"
                xmlns="http://www.w3.org/2000/svg"
            >
                <path style={{color: "#f00"}}
                      d="M273.21 188.185C273.065 188.24 272.71 188.415 272.575 188.305C272.44 188.195 272.865 187.805 272.935 187.725L273.72 186.86C273.852 186.731 273.953 186.575 274.016 186.402C274.08 186.228 274.103 186.043 274.085 185.86C273.996 185.616 273.884 185.382 273.75 185.16C273.609 184.873 273.529 184.56 273.515 184.24C273.515 184.105 273.515 183.635 273.3 183.665C273.085 183.695 272.95 183.99 272.85 184.12L272.795 184.19C272.7 184.32 272.51 184.655 272.295 184.605C272.08 184.555 272.295 184.26 272.295 184.175C272.355 183.915 272.435 183.555 272.475 183.37C272.534 183.008 272.571 182.642 272.585 182.275L272.63 181.5C272.63 181.08 272.705 180.395 272.755 180V179.905C272.791 179.436 272.715 178.965 272.535 178.53C272.326 178.095 272.139 177.649 271.975 177.195C271.82 176.709 271.732 176.205 271.715 175.695V175.295C271.703 174.851 271.524 174.428 271.215 174.11C270.855 173.804 270.521 173.47 270.215 173.11L270.125 172.99C269.884 172.696 269.705 172.356 269.6 171.99C269.609 171.698 269.729 171.421 269.935 171.215C270.095 171.045 270.37 170.8 270.185 170.57C270.03 170.423 269.851 170.305 269.655 170.22C269.335 170.04 269.1 169.72 269.155 169.495C269.207 169.237 269.284 168.984 269.385 168.74C269.422 168.592 269.428 168.438 269.403 168.287C269.378 168.137 269.323 167.993 269.24 167.865L268.705 166.95C268.575 166.71 268.495 166.447 268.47 166.175C268.403 165.817 268.263 165.477 268.06 165.175L267.83 164.805C267.71 164.61 267.54 164.36 267.37 164.12C267.2 163.88 267.08 163.705 266.96 163.555L266.545 163.015C266.274 162.59 265.937 162.212 265.545 161.895C265.505 161.871 265.466 161.844 265.43 161.815C265.268 161.648 265.125 161.464 265.005 161.265C264.905 161.135 264.75 160.9 264.575 160.87C264.396 160.87 264.221 160.926 264.075 161.03C263.87 161.135 263.52 160.93 263.295 160.575L262.795 159.795C262.53 159.364 262.313 158.907 262.145 158.43L261.84 157.505C261.692 157.016 261.59 156.513 261.535 156.005L261.37 154.18L261.225 152.68L261.055 151.035C261.02 150.755 261.01 150.472 261.025 150.19C261.05 149.96 261.18 149.785 261.065 149.55C260.968 149.209 260.946 148.851 261 148.5V147.13C261 146.71 261.04 146.025 261.065 145.605L261.15 144.105C261.19 143.597 261.283 143.094 261.425 142.605L262.325 139.715C262.436 139.367 262.52 139.011 262.575 138.65C262.607 138.482 262.592 138.309 262.53 138.15C262.507 138.126 262.479 138.109 262.447 138.1C262.415 138.091 262.382 138.091 262.35 138.1C262.31 138.1 262.015 138.36 261.7 138.635L261 139.25C260.612 139.557 260.156 139.764 259.67 139.855L259.415 139.885C258.927 139.928 258.438 139.823 258.01 139.585L257.82 139.465C257.422 139.203 257.082 138.863 256.82 138.465C256.683 138.192 256.488 137.952 256.25 137.76C255.991 137.576 255.758 137.359 255.555 137.115C255.268 136.808 254.875 136.62 254.455 136.59C254.003 136.547 253.574 136.373 253.22 136.09C252.855 135.8 252.53 135.48 252.175 135.175C252.136 135.135 252.088 135.104 252.035 135.085C251.985 135.076 251.933 135.081 251.885 135.099C251.837 135.118 251.796 135.149 251.765 135.19C251.665 135.346 251.584 135.514 251.525 135.69L250.37 138.09C250.151 138.547 249.984 139.026 249.87 139.52L249.12 143.235C249.038 143.703 249.038 144.182 249.12 144.65C249.2 145.02 249.395 145.32 249.55 145.32C249.758 145.303 249.957 145.228 250.125 145.105C250.357 144.96 250.618 144.87 250.89 144.84C251.158 144.813 251.418 144.733 251.655 144.605C251.846 144.484 252.056 144.395 252.275 144.34C252.485 144.291 252.685 144.21 252.87 144.1C253.192 143.994 253.536 143.97 253.87 144.03C254.344 144.062 254.813 143.92 255.19 143.63L255.94 142.995C256.261 142.725 256.545 142.414 256.785 142.07C256.93 141.835 257.285 141.89 257.575 142.19L257.615 142.235C257.948 142.609 258.203 143.046 258.365 143.52L258.69 144.59C258.814 145.072 258.831 145.576 258.74 146.065L257.93 149.64C257.798 150.115 257.545 150.548 257.195 150.895L256 152C255.93 152.065 255.847 152.115 255.756 152.145C255.665 152.175 255.569 152.185 255.473 152.174C255.378 152.163 255.287 152.132 255.205 152.082C255.123 152.032 255.053 151.965 255 151.885L254.97 151.845C254.68 151.462 254.298 151.157 253.86 150.96C253.438 150.764 253.099 150.423 252.905 150C252.834 149.819 252.728 149.654 252.592 149.515C252.456 149.376 252.294 149.265 252.115 149.19C251.874 149.126 251.624 149.102 251.375 149.12C251.245 149.12 251.03 149.415 250.9 149.715C250.762 150.056 250.721 150.427 250.78 150.79C250.816 151.201 250.714 151.613 250.49 151.96L250.065 152.63C249.888 152.94 249.631 153.195 249.32 153.37C248.964 153.378 248.615 153.275 248.32 153.075L247.865 152.805C247.466 152.537 247.176 152.134 247.05 151.67L246.225 147.855C246.132 147.361 246.103 146.857 246.14 146.355L246.275 145.005C246.285 144.778 246.239 144.553 246.14 144.349C246.041 144.145 245.894 143.968 245.71 143.835L245.275 143.56C245.083 143.448 244.864 143.393 244.642 143.4C244.42 143.407 244.204 143.476 244.02 143.6L243.76 143.79C243.578 143.913 243.364 143.981 243.144 143.987C242.925 143.992 242.708 143.934 242.52 143.82C242.024 143.568 241.577 143.229 241.2 142.82C241.155 142.745 241.09 142.655 241.005 142.665C240.92 142.675 240.885 142.77 240.86 142.85C240.625 143.69 240.36 144.505 240.055 145.35C239.93 145.668 239.874 146.009 239.89 146.35C239.973 146.679 240.035 147.013 240.075 147.35L240.015 149.885C239.994 150.389 239.93 150.891 239.825 151.385L239.4 153.245C239.316 153.636 239.162 154.009 238.945 154.345C238.771 154.551 238.523 154.68 238.255 154.705C237.89 154.773 237.553 154.947 237.285 155.205L237.165 155.315C237.015 155.455 236.826 155.545 236.623 155.574C236.42 155.602 236.213 155.568 236.03 155.475C235.842 155.381 235.632 155.339 235.422 155.353C235.212 155.367 235.009 155.437 234.835 155.555L234.51 155.78C234.104 156.079 233.738 156.429 233.42 156.82L232 158.73C231.745 159.065 231.715 159.42 231.94 159.525C232.253 159.749 232.489 160.066 232.615 160.43L232.89 161.155C233.061 161.633 233.196 162.122 233.295 162.62L233.5 163.745C233.542 163.961 233.608 164.173 233.695 164.375C233.754 164.524 233.838 164.661 233.945 164.78C234.181 165.082 234.339 165.437 234.405 165.815L234.635 166.95C234.715 167.45 234.687 167.961 234.555 168.45L233.24 172.68C233.076 173.152 232.83 173.592 232.515 173.98L231.515 175.125C231.292 175.399 231.016 175.627 230.705 175.795C230.356 175.806 230.01 175.722 229.705 175.55L228.965 175.18C228.59 174.99 228.35 175.18 228.425 175.59L228.58 176.43C228.669 176.873 228.854 177.29 229.12 177.655C230.07 178.77 231.085 177.025 232.12 177.235L232.535 177.315C233.01 177.428 233.446 177.664 233.8 178L234.145 178.365C234.473 178.742 234.723 179.18 234.88 179.655L235.38 181.295C235.506 181.784 235.55 182.291 235.51 182.795L234.77 189.64C234.695 190.131 234.514 190.6 234.24 191.015L233.41 192.165C233.165 192.505 232.795 193.03 232.585 193.335C232.335 193.733 232.165 194.177 232.085 194.64L231.645 197.715V197.81C231.566 198.318 231.451 198.819 231.3 199.31L229.485 204.835C229.311 205.303 229.05 205.734 228.715 206.105L227.5 207.28C227.156 207.648 226.868 208.064 226.645 208.515L225.385 211.205L228.43 213.035C228.665 213.193 228.856 213.408 228.985 213.66L229.57 214.955C229.698 215.211 229.883 215.435 230.11 215.61L231.175 216.365C231.279 216.449 231.365 216.553 231.426 216.672C231.487 216.791 231.523 216.921 231.53 217.055V218.17C231.521 218.305 231.485 218.436 231.424 218.556C231.363 218.677 231.278 218.783 231.175 218.87L229.175 220.345C228.956 220.52 228.799 220.76 228.725 221.03L227.45 226.675C227.403 226.948 227.462 227.229 227.615 227.46L228.975 229.27C229.028 229.345 229.059 229.433 229.065 229.525C229.079 229.601 229.076 229.679 229.058 229.754C229.04 229.828 229.007 229.899 228.96 229.96L226.375 233.06C226.208 233.286 226.119 233.559 226.12 233.84L226.275 236.11C226.277 236.233 226.24 236.354 226.169 236.455C226.098 236.555 225.997 236.631 225.88 236.67L220.22 238.31C220.096 238.353 219.985 238.427 219.897 238.525C219.81 238.623 219.749 238.742 219.72 238.87L219.125 242.615C219.09 242.899 219.124 243.187 219.225 243.455L219.935 245.16C220.036 245.432 220.085 245.72 220.08 246.01L219.915 249.43C219.916 249.556 219.953 249.678 220.022 249.783C220.091 249.888 220.19 249.97 220.305 250.02L221.805 250.56C222.071 250.647 222.359 250.647 222.625 250.56L227.16 248.695C227.425 248.574 227.67 248.416 227.89 248.225L230.285 245.995C230.501 245.815 230.769 245.71 231.05 245.695H234.155C234.442 245.707 234.723 245.778 234.98 245.905L238.405 247.79C238.646 247.939 238.846 248.148 238.985 248.395L239.955 250.335C240.089 250.589 240.257 250.823 240.455 251.03L242.855 253.26C243.068 253.437 243.339 253.528 243.615 253.515L244.45 253.435C244.509 253.43 244.566 253.412 244.618 253.384C244.67 253.355 244.716 253.316 244.752 253.269C244.788 253.222 244.814 253.168 244.828 253.111C244.843 253.053 244.845 252.993 244.835 252.935V252.785C244.811 252.564 244.743 252.35 244.635 252.155C244.601 252.061 244.591 251.96 244.604 251.861C244.617 251.762 244.653 251.667 244.71 251.585L244.915 251.23C244.982 251.124 245.079 251.039 245.194 250.988C245.309 250.936 245.436 250.92 245.56 250.94L246.015 251.04C246.25 251.09 246.635 251.19 246.865 251.255L249.615 252.03C249.603 251.938 249.613 251.845 249.644 251.758C249.676 251.671 249.727 251.593 249.795 251.53C250.106 251.387 250.425 251.264 250.75 251.16L250.98 251.08C251.375 250.945 251.815 250.78 251.98 250.71C252.241 250.507 252.465 250.26 252.64 249.98C252.847 249.673 253.005 249.335 253.11 248.98C253.164 248.599 253.199 248.215 253.215 247.83L253.26 246.88C253.26 246.46 253.335 245.775 253.38 245.38L253.425 244.965C253.475 244.55 253.57 243.87 253.645 243.465L253.825 242.465C253.9 242.055 253.995 241.465 254.04 241.185C254.085 240.905 254.14 240.315 254.16 239.895L254.25 238.265C254.25 237.845 254.31 237.39 254.335 237.265C254.353 236.931 254.336 236.596 254.285 236.265L254.1 234.86C254.05 234.44 253.965 233.76 253.915 233.36L253.81 232.425C253.76 232.01 253.715 231.5 253.705 231.295C253.645 230.967 253.51 230.657 253.31 230.39C253.134 230.162 253.001 229.905 252.915 229.63C252.892 229.436 252.855 229.244 252.805 229.055C252.683 228.72 252.524 228.4 252.33 228.1C252.127 227.781 251.986 227.426 251.915 227.055C251.912 227.01 251.912 226.965 251.915 226.92C251.915 226.64 251.915 226.2 251.915 225.845L251.94 225.345C251.965 224.925 252.01 224.27 252.045 223.88C252.08 223.49 252.155 222.84 252.21 222.425L252.275 221.925C252.392 221.41 252.56 220.907 252.775 220.425C252.955 219.9 253.1 219.37 253.325 218.87V218.83C253.443 218.55 253.582 218.279 253.74 218.02C253.79 217.958 253.861 217.917 253.94 217.905C253.998 217.906 254.055 217.916 254.11 217.935C254.15 217.935 254.22 217.69 254.265 217.35C254.316 216.985 254.442 216.634 254.635 216.32C254.807 216.083 254.999 215.863 255.21 215.66C255.339 215.534 255.497 215.441 255.67 215.39C255.758 215.378 255.848 215.395 255.925 215.44C255.982 215.522 256.028 215.611 256.06 215.705C256.09 215.762 256.138 215.808 256.197 215.835C256.256 215.862 256.322 215.869 256.385 215.855C256.604 215.778 256.801 215.649 256.96 215.48C257.124 215.305 257.326 215.17 257.55 215.085L258.34 214.91C258.77 214.833 259.204 214.778 259.64 214.745C259.881 214.689 260.131 214.681 260.375 214.72C260.675 214.81 260.78 215.06 261.125 215.075C261.252 215.084 261.38 215.075 261.505 215.05C261.555 215.05 261.62 215.08 261.655 215.15C261.693 215.24 261.722 215.334 261.74 215.43C261.822 215.72 261.921 216.006 262.035 216.285L262.065 216.355C262.156 216.604 262.307 216.826 262.507 217.001C262.706 217.176 262.946 217.298 263.205 217.355C263.381 217.4 263.564 217.412 263.745 217.39C263.803 217.379 263.858 217.354 263.905 217.318C263.952 217.281 263.99 217.234 264.015 217.18C264.027 217.134 264.021 217.085 263.999 217.042C263.977 217 263.94 216.967 263.895 216.95C263.8 216.91 263.725 216.83 263.73 216.775C263.746 216.705 263.774 216.639 263.815 216.58C263.846 216.431 263.827 216.277 263.76 216.14C263.705 215.966 263.585 215.819 263.425 215.73C263.312 215.692 263.219 215.611 263.165 215.505C263.135 215.42 263.3 215.275 263.535 215.185C263.77 215.095 263.955 214.98 263.94 214.93C263.925 214.88 263.77 214.85 263.6 214.855C263.523 214.86 263.445 214.843 263.378 214.805C263.31 214.767 263.255 214.709 263.22 214.64C263.189 214.573 263.143 214.513 263.086 214.465C263.029 214.418 262.962 214.383 262.89 214.365C262.745 214.33 262.74 214.13 262.89 213.92C262.981 213.763 263.094 213.62 263.225 213.495C263.27 213.495 263.3 213.375 263.29 213.27C263.278 213.163 263.238 213.062 263.175 212.975C263.12 212.915 263.215 212.815 263.39 212.75C263.51 212.662 263.61 212.548 263.682 212.418C263.755 212.288 263.798 212.144 263.81 211.995C263.876 211.746 263.864 211.482 263.775 211.24C263.7 211.17 263.465 211.19 263.275 211.285C263.085 211.38 262.865 211.325 262.835 211.17C262.785 210.982 262.672 210.816 262.515 210.7C262.365 210.59 262.39 210.47 262.57 210.425C262.835 210.34 263.084 210.21 263.305 210.04C263.385 209.983 263.449 209.908 263.494 209.821C263.539 209.734 263.562 209.638 263.562 209.54C263.562 209.442 263.539 209.346 263.494 209.259C263.449 209.172 263.385 209.097 263.305 209.04C263.213 208.975 263.102 208.944 262.99 208.95C262.88 208.957 262.77 208.957 262.66 208.95C262.455 208.925 262.24 208.82 262.245 208.59C262.244 208.515 262.257 208.441 262.285 208.371C262.313 208.302 262.355 208.239 262.407 208.186C262.46 208.133 262.523 208.091 262.592 208.062C262.661 208.034 262.735 208.019 262.81 208.02C262.938 208.017 263.065 207.986 263.18 207.93C263.288 207.86 263.371 207.759 263.42 207.64C263.504 207.486 263.622 207.352 263.765 207.25C263.915 207.145 264.09 207.125 264.16 207.205C264.226 207.283 264.319 207.335 264.42 207.35C264.437 207.349 264.454 207.345 264.469 207.338C264.485 207.331 264.499 207.321 264.511 207.308C264.522 207.296 264.531 207.281 264.537 207.265C264.543 207.249 264.546 207.232 264.545 207.215C264.532 207.076 264.507 206.939 264.47 206.805C264.403 206.611 264.299 206.431 264.165 206.275C264.107 206.217 264.066 206.145 264.046 206.066C264.026 205.987 264.027 205.903 264.05 205.825C264.143 205.62 264.219 205.408 264.275 205.19C264.312 204.989 264.412 204.806 264.56 204.665C264.682 204.594 264.791 204.505 264.885 204.4C265.006 204.173 265.075 203.922 265.085 203.665C265.084 203.468 265.142 203.275 265.25 203.11C265.37 202.965 265.51 202.765 265.72 202.755C265.835 202.761 265.947 202.79 266.05 202.84L266.335 202.99C266.39 203.025 266.41 202.885 266.375 202.685C266.317 202.425 266.235 202.17 266.13 201.925C266.079 201.807 266.037 201.685 266.005 201.56C265.946 201.338 265.901 201.113 265.87 200.885C265.834 200.606 265.813 200.326 265.81 200.045C265.816 199.992 265.837 199.942 265.87 199.901C265.904 199.86 265.949 199.83 266 199.815C266.105 199.797 266.213 199.817 266.305 199.87C266.449 200.017 266.569 200.186 266.66 200.37C266.785 200.595 267.01 200.505 267.16 200.17C267.284 199.911 267.386 199.642 267.465 199.365C267.489 199.235 267.542 199.112 267.62 199.005C267.641 198.976 267.668 198.951 267.699 198.933C267.73 198.915 267.764 198.904 267.8 198.9C267.865 198.9 267.945 198.975 267.93 199.04C267.913 199.079 267.89 199.115 267.86 199.145C267.86 199.18 267.83 199.235 267.86 199.26C267.876 199.265 267.894 199.265 267.91 199.26C268.139 199.285 268.371 199.285 268.6 199.26H269.005C269.203 199.251 269.396 199.197 269.569 199.102C269.743 199.006 269.892 198.872 270.005 198.71C270.15 198.425 270.115 198.115 269.93 198.02C269.792 197.945 269.678 197.834 269.6 197.698C269.522 197.562 269.484 197.407 269.49 197.25C269.487 197.227 269.487 197.203 269.49 197.18C269.513 197.148 269.547 197.127 269.585 197.12C269.715 197.09 269.84 197.17 269.965 197.195C270.09 197.22 270.175 197.195 270.245 197.27C270.281 197.32 270.313 197.374 270.34 197.43C270.37 197.43 270.385 197.405 270.395 197.375C270.395 197.24 270.445 197.105 270.475 196.97C270.505 196.835 270.53 196.69 270.475 196.605C270.393 196.525 270.297 196.462 270.19 196.42C270.165 196.412 270.142 196.399 270.123 196.382C270.103 196.365 270.088 196.344 270.077 196.321C270.066 196.297 270.06 196.271 270.06 196.246C270.06 196.22 270.065 196.194 270.075 196.17C270.229 196.015 270.426 195.909 270.64 195.865C270.9 195.79 271.14 195.66 271.14 195.58C271.088 195.422 270.987 195.285 270.85 195.19C270.43 194.845 270.905 194.69 271.205 194.525C271.364 194.443 271.532 194.379 271.705 194.335C271.734 194.334 271.762 194.339 271.789 194.349C271.815 194.36 271.839 194.375 271.86 194.395C271.895 194.429 271.941 194.449 271.99 194.45C272.035 194.45 271.99 194.32 271.94 194.165C271.812 193.967 271.622 193.818 271.4 193.74C271.175 193.665 271.02 193.51 271.05 193.4C271.063 193.348 271.091 193.3 271.13 193.263C271.169 193.226 271.217 193.201 271.27 193.19C271.314 193.188 271.357 193.174 271.394 193.149C271.431 193.124 271.461 193.09 271.48 193.05C271.468 192.899 271.406 192.757 271.305 192.645C271.08 192.345 271.255 192.25 271.55 192.185C271.705 192.155 271.855 192.108 272 192.045C272.08 192 272.05 191.905 271.94 191.83C271.83 191.755 271.615 191.7 271.505 191.51C271.454 191.43 271.427 191.337 271.427 191.242C271.427 191.148 271.454 191.055 271.505 190.975C271.591 190.873 271.699 190.791 271.82 190.735C272.002 190.582 272.14 190.384 272.22 190.16C272.32 189.922 272.407 189.678 272.48 189.43C272.515 189.295 272.58 189.21 272.63 189.24C272.688 189.288 272.73 189.352 272.75 189.425C272.778 189.47 272.819 189.507 272.866 189.532C272.913 189.556 272.967 189.568 273.02 189.565C273.14 189.565 273.405 189.27 273.6 188.9L273.65 188.81C273.845 188.44 273.97 188.11 273.92 188.075C273.678 188.062 273.437 188.1 273.21 188.185Z"></path>

            </svg>
        </div>
    );
}

// ポリラインをデコードする関数
function decodePolyline(encoded: string) {
    let points = [];
    let index = 0,
        len = encoded.length;
    let lat = 0,
        lng = 0;

    while (index < len) {
        let b, shift = 0,
            result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlat = result & 1 ? ~(result >> 1) : result >> 1;
        lat += dlat;

        shift = 0;
        result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlng = result & 1 ? ~(result >> 1) : result >> 1;
        lng += dlng;

        points.push({lat: lat / 1e5, lng: lng / 1e5});
    }

    return points;
}